dist: focal
addons:
  apt:
    update: true
    packages: [ gcc, clang, musl, musl-dev, musl-tools, util-linux ]
language: c
branches:
  only:
  - master
  - travis
matrix:
  include:
    - name: "amd64 / gcc / glibc / dynamic"
      arch: amd64
      os: linux
      env:
         - CC="gcc"
    - name: "amd64 / clang / libclang / dynamic"
      arch: amd64
      os: linux
      env:
         - CC="clang"
    - name: "amd64 / musl-gcc / musl / static"
      arch: amd64
      os: linux
      env:
         # https://gcc.gnu.org/onlinedocs/gcc/Directory-Options.html
         #  -idirafter /usr/include/                  # Needed for Travis/Ubuntu build to pass, for linux/kd.h, etc.
         #  -idirafter /usr/include/x86_64-linux-gnu/ # Needed for Travis/Ubuntu build to pass, for asm/types.h
         - CC="musl-gcc -static -idirafter /usr/include/ -idirafter /usr/include/x86_64-linux-gnu/"
script:
  - make
  - make test

after_failure:
  - |
    for d in tests/*; do
      test -d "$d" || continue
      printf '>>> %s\n' "$d"
      test -e "$d/syslogd.log" && cat "$d/syslogd.log"
      printf '<<<\n'
    done
